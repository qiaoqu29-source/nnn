<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI OS Refined</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5F5F7">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Styles -->
    <link rel="stylesheet" href="style-refined.css">
</head>
<body>

<div id="phone-wrapper">
    <!-- ========== 状态栏 ========== -->
    <div class="status-bar" id="st-bar">
        <div id="st-time">12:00</div>
        <div class="status-right">
            <span>5G</span>
            <div class="battery">
                <div class="battery-level"></div>
            </div>
        </div>
    </div>

    <!-- ========== 系统通知横幅 ========== -->
    <div id="noti-banner" class="noti-banner" onclick="jumpToChat()">
        <div class="noti-icon">
            <i class="fas fa-comment"></i>
        </div>
        <div class="noti-content">
            <div id="noti-n">角色名字</div>
            <div id="noti-t">消息内容...</div>
        </div>
    </div>

    <!-- ========== 桌面图层 ========== -->
    <div class="desktop-layer">
        <!-- Profile 卡片 -->
        <div class="profile-card centered">
            <div class="profile-avatar large">
                <img src="https://api.dicebear.com/9.x/micah/svg?seed=Moom" id="desktop-main-avatar" alt="Profile">
            </div>
            <div class="profile-info">
                <div class="p-name">Hello, User.</div>
                <div class="p-handle">Creative Developer</div>
            </div>
        </div>

        <!-- 桌面网格布局 -->
        <div class="dashboard-grid">
            <!-- 左侧装饰卡片 -->
            <div class="widget-column">
                <div class="text-widget">
                    <div class="dot"></div>
                    <span>Stay<br>Focused</span>
                </div>
                <div class="text-widget">
                    <span>Create<br>Magic</span>
                    <div class="dot gray"></div>
                </div>
            </div>

            <!-- 应用图标网格（动态渲染） -->
            <div class="app-grid" id="desktop-app-grid">
                <!-- JavaScript 动态填充 -->
            </div>
        </div>

        <!-- 底部 Dock -->
        <div class="dock">
            <div class="dock-item" onclick="openApp('win-sets')" title="设置">
                <i class="fas fa-sliders"></i>
            </div>
            <div class="dock-item" onclick="openApp('win-chat')" title="消息">
                <i class="fas fa-message"></i>
            </div>
            <div class="dock-item" title="相册">
                <i class="fas fa-image"></i>
            </div>
            <div class="dock-item" title="浏览器">
                <i class="fab fa-chrome"></i>
            </div>
        </div>
    </div>

    <!-- ========== 全局设置窗口 ========== -->
    <div class="app-window" id="win-sets">
        <div class="window-nav">
            <button onclick="closeApp('win-sets')">取消</button>
            <span>系统设置</span>
            <button onclick="saveGlobalSets()" style="font-weight:700">完成</button>
        </div>
        <div class="window-content">
            <!-- API 配置 -->
            <div class="setting-group">
                <div class="setting-row">
                    <label>API 地址</label>
                    <input type="text" id="set-url" placeholder="https://api.example.com">
                </div>
                <div class="setting-row">
                    <label>API Key</label>
                    <input type="password" id="set-key" placeholder="sk-...">
                </div>
                <div class="setting-row">
                    <label>模型名称</label>
                    <div style="display: flex; gap: 8px; align-items: center; width: 60%;">
                        <input type="text" id="set-model" style="flex: 1;" placeholder="gpt-4o">
                        <button class="fetch-btn" onclick="fetchModels()" style="padding: 6px 12px; background: var(--accent-soft); color: var(--accent); border: none; border-radius: 8px; font-size: 13px; cursor: pointer;">拉取</button>
                    </div>
                </div>
            </div>

            <!-- 外观配置 -->
            <div class="setting-group">
                <div class="setting-row">
                    <label>壁纸 URL</label>
                    <input type="text" id="set-bg" placeholder="图片链接">
                </div>
                <div class="setting-row">
                    <label>回复温度</label>
                    <input type="range" id="set-temp" min="0" max="2" step="0.1" value="0.7">
                </div>
            </div>

            <!-- 操作按钮 -->
            <button class="btn-action" onclick="exportData()">
                <i class="fas fa-file-export"></i> 备份全部数据
            </button>
            <button class="btn-danger" onclick="if(confirm('确定要重置所有数据吗？'))localStorage.clear();location.reload();">
                <i class="fas fa-trash"></i> 彻底重置应用
            </button>
        </div>
    </div>

    <!-- ========== 消息列表窗口 ========== -->
    <div class="app-window" id="win-chat">
        <div class="window-nav">
            <button onclick="closeApp('win-chat')">桌面</button>
            <span>所有消息</span>
            <button onclick="showCreateModal()" style="font-size:22px">＋</button>
        </div>
        <div class="window-content" id="list-con">
            <!-- JavaScript 动态填充 -->
        </div>
    </div>

    <!-- ========== 角色详情设置 ========== -->
    <div class="app-window" id="win-char-settings">
        <div class="window-nav">
            <button onclick="closeApp('win-char-settings')">关闭</button>
            <span>角色设置</span>
            <button onclick="saveCharSettings()" style="font-weight:700">保存</button>
        </div>
        <div class="window-content">
            <!-- 头像编辑区 -->
            <div class="avatar-section">
                <div class="avatar-item">
                    <div class="avatar-preview" id="ai-avatar-preview" onclick="uploadAvatar('ai')">
                        <!-- 动态填充 -->
                    </div>
                    <span>AI 头像</span>
                </div>
                <div class="avatar-item">
                    <div class="avatar-preview" id="user-avatar-preview" onclick="uploadAvatar('user')">
                        <!-- 动态填充 -->
                    </div>
                    <span>我的头像</span>
                </div>
            </div>

            <!-- 基础信息 -->
            <div class="setting-group">
                <div class="setting-row">
                    <label>备注名</label>
                    <input type="text" id="char-nickname" placeholder="显示名称">
                </div>
                <div class="setting-row">
                    <label>角色真名</label>
                    <input type="text" id="char-realname" placeholder="完整姓名">
                </div>
                <div class="setting-row">
                    <label>用户昵称</label>
                    <input type="text" id="char-username" placeholder="你的昵称">
                </div>
                <div class="setting-row">
                    <label>好友分组</label>
                    <input type="text" id="char-group" placeholder="工作/朋友/家人">
                </div>
                <div class="setting-row">
                    <label>应用图标</label>
                    <input type="text" id="char-icon-url" placeholder="图标链接">
                </div>
            </div>

            <!-- 高级设置 -->
            <div class="setting-group">
                <div class="setting-row clickable" onclick="openPersonaEditor('ai')">
                    <label>AI Persona</label>
                    <i class="fas fa-chevron-right" style="color: var(--text-tertiary);"></i>
                </div>
                <div class="setting-row clickable" onclick="openPersonaEditor('user')">
                    <label>My Persona</label>
                    <i class="fas fa-chevron-right" style="color: var(--text-tertiary);"></i>
                </div>
                <div class="setting-row clickable" onclick="openMemoryEditor()">
                    <label>长期记忆</label>
                    <i class="fas fa-chevron-right" style="color: var(--text-tertiary);"></i>
                </div>
            </div>

            <!-- 主动消息 -->
            <div class="setting-group">
                <div class="setting-row">
                    <label>主动发消息</label>
                    <input type="checkbox" id="char-active">
                </div>
                <div class="setting-row">
                    <label>间隔（分钟）</label>
                    <input type="number" id="char-interval" min="1" placeholder="60">
                </div>
            </div>

            <!-- 危险操作 -->
            <button class="btn-danger" onclick="deleteChar()">
                <i class="fas fa-trash"></i> 删除此角色
            </button>
        </div>
    </div>

    <!-- ========== 聊天窗口 ========== -->
    <div class="chat-window" id="win-room">
        <div class="window-nav">
            <button onclick="exitRoom()">
                <i class="fas fa-chevron-left"></i> 返回
            </button>
            <span id="room-n">角色名</span>
            <button onclick="openCharSettings()">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <!-- 消息区域 -->
        <div class="chat-messages" id="im-scroll">
            <div id="im-inject">
                <!-- JavaScript 动态填充 -->
            </div>
        </div>

        <!-- 输入栏 -->
        <div class="chat-footer">
            <div class="chat-input-row">
                <div class="input-btn" onclick="toggleTools()">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="input-wrap">
                    <input 
                        type="text" 
                        id="chat-inp" 
                        placeholder="输入消息..." 
                        onkeypress="if(event.key==='Enter')handleSend()"
                    >
                </div>
                <button class="send-btn" onclick="handleSend()">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>

            <!-- 工具面板 -->
            <div class="tools-panel" id="t-panel">
                <div class="tool-item" onclick="up('img')">
                    <div class="tool-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <span>相册</span>
                </div>
                <div class="tool-item" onclick="up('file')">
                    <div class="tool-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <span>文件</span>
                </div>
                <div class="tool-item" onclick="clearHistory()">
                    <div class="tool-icon">
                        <i class="fas fa-trash"></i>
                    </div>
                    <span>清空</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== Persona 编辑器 ========== -->
    <div class="app-window" id="win-persona-editor">
        <div class="window-nav">
            <button onclick="closePersonaEditor()">返回</button>
            <span id="persona-title">编辑 Persona</span>
            <button onclick="savePersona()" style="font-weight:700">保存</button>
        </div>
        <div class="window-content">
            <textarea 
                id="persona-textarea" 
                class="full-textarea" 
                placeholder="描述角色的性格、说话风格、背景故事..."
                style="font-family: var(--font-body); color: var(--text);"
            ></textarea>
            <button class="btn-magic-full" onclick="aiGeneratePersona()">
                <i class="fas fa-wand-magic-sparkles"></i> AI 智能生成
            </button>
        </div>
    </div>

    <!-- ========== 创建角色弹窗 ========== -->
    <div class="modal-overlay" id="mo-overlay" onclick="hideModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 20px; color: var(--text);">新建角色</h3>
            
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">角色名称</label>
            <input 
                type="text" 
                id="mo-n" 
                placeholder="例如：小助手" 
                style="width: 100%; padding: 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; margin-bottom: 16px; font-family: var(--font-body);"
            >
            
            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">角色描述（可选）</label>
            <textarea 
                id="mo-p" 
                placeholder="描述角色的个性和特点..." 
                style="width: 100%; padding: 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; min-height: 100px; resize: vertical; font-family: var(--font-body); margin-bottom: 20px;"
            ></textarea>
            
            <div class="modal-actions" style="display: flex; gap: 12px;">
                <button 
                    class="btn-cancel" 
                    onclick="hideModal()"
                    style="flex: 1; padding: 14px; border: none; background: rgba(0,0,0,0.05); color: var(--text); border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                >
                    取消
                </button>
                <button 
                    class="btn-confirm" 
                    onclick="commitModal()"
                    style="flex: 1; padding: 14px; border: none; background: var(--accent); color: white; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,102,255,0.2);"
                >
                    创建
                </button>
            </div>
        </div>
    </div>

    <!-- ========== 模型选择弹窗 ========== -->
    <div class="modal-overlay" id="model-overlay" onclick="hideModelList()">
        <div class="modal-box" onclick="event.stopPropagation()" style="max-height: 70vh; overflow-y: auto;">
            <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 20px; color: var(--text);">选择模型</h3>
            <div id="model-list-inject" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- JavaScript 动态填充 -->
            </div>
        </div>
    </div>

    <!-- ========== 隐藏的文件上传控件 ========== -->
    <input type="file" id="up-i" accept="image/*" style="display:none" onchange="dImg(this)">
    <input type="file" id="up-f" accept=".txt,.md,.json" style="display:none" onchange="dFile(this)">
    <input type="file" id="up-avatar" accept="image/*" style="display:none" onchange="handleAvatarUpload(this)">
    <canvas id="comp-c" style="display:none"></canvas>

    <!-- Scripts -->
    <script src="script-refined.js"></script>
</div>

</body>
</html>
